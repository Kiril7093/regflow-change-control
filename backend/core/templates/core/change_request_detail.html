{% extends "core/base.html" %}

{% block title %}CR#{{ cr.id }} · {{ cr.title }} · RegFlow{% endblock %}

{% block content %}
  <div class="row between" style="gap:12px; margin-bottom:12px;">
    <div>
      <div class="row" style="gap:10px; align-items:center;">
        <h1 class="h1" style="margin:0;">CR#{{ cr.id }} — {{ cr.title }}</h1>
        <span class="badge {{ cr.status }}">{{ cr.get_status_display }}</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        Type: {{ cr.get_change_type_display }} · Created by {{ cr.created_by.username }} · Updated {{ cr.updated_at|date:"M j, Y g:i A" }}
      </div>
    </div>

    <div class="row" style="gap:10px;">
      <a class="btn" href="/change-requests/">← Back</a>

      {% if cr.status == "draft" %}
        <a class="btn" href="/change-requests/{{ cr.id }}/edit/">Edit</a>
        <form method="post" action="/change-requests/{{ cr.id }}/submit/" style="display:inline;">
          {% csrf_token %}
          <button class="btn primary" type="submit">Submit for review</button>
        </form>
      {% endif %}

      {% if cr.status == "in_review" %}
        <form method="post" action="/change-requests/{{ cr.id }}/approve/" style="display:inline;">
          {% csrf_token %}
          <button class="btn primary" type="submit">Approve</button>
        </form>
        <form method="post" action="/change-requests/{{ cr.id }}/reject/" style="display:inline;">
          {% csrf_token %}
          <button class="btn danger" type="submit">Reject</button>
        </form>
      {% endif %}

      <a class="btn" href="/change-requests/{{ cr.id }}/pdf/" target="_blank" rel="noopener">View PDF</a>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2 class="h2">Rationale</h2>
      <div class="muted" style="white-space:pre-wrap;">{{ cr.rationale }}</div>
    </div>

    <div class="card">
      <h2 class="h2">Audit trail</h2>
      {% if audit_events %}
        <ul class="list">
          {% for e in audit_events %}
            <li>
              <div class="muted">{{ e.created_at|date:"M j, Y g:i A" }}</div>
              <div>
                <span class="mono">{{ e.action }}</span>
                — <span class="muted">{{ e.actor.username }}</span>
                {% if e.message %}: {{ e.message }}{% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">No events recorded.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}
